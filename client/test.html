<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="jquery.js"></script>
    <style>
        b {
            color: blue;
        }
    </style>

</head>

<body>
<form>
    <fieldset>
        <label for="target">Recherche : </label>
        <input id="target" type="text">
    </fieldset>
</form>
<div id="result">

</div>
<script>
    var minQueryLength = 2;

    var defaultDiacritics = [
        { base: 'a', letters: 'äâà' },
        { base: 'e', letters: 'éèëê' },
        { base: 'i', letters: 'ïî' },
        { base: 'o', letters: 'öô' },
        { base: 'u', letters: 'ùüû' },
        { base: 'c', letters: 'ç' },
        { base: 'oe', letters: 'œ' }
    ];

    var diacriticsMap = [];
    for (var i = 0; i < defaultDiacritics.length; i++) {
        var letters = defaultDiacritics[i].letters.split("");
        for (var j = 0; j < letters.length; j++) {
            diacriticsMap[letters[j]] = defaultDiacritics[i].base;
        }
    }

    var removeDiacritics = function (sentence) {
        if (!sentence)
            return '';
        var map = this.diacriticsMap;
        sentence = sentence.toLowerCase().replace(/[^\u0000-\u007E]/g, function (a) {
            return map[a] || a;
        });
        return sentence;
    };


    var toQuery = function (words) {
        var length = words.length;
        var result = "";
        var first = true;
        for (var i = 0; i < length; i++) {
            if (words[i] !== "") {
                if (!first) {
                    result += " ";
                }
                result += words[i] + "*";
                first = false;
            }
        }
        return result;
    };

    var normalize = function (sentence) {
        if (!sentence)
            return [];
        sentence = removeDiacritics(sentence);
        var query = sentence.split(/[^a-z0-9]+/i);

        //sort min length to max length
        query.sort(function(a,b) {
            return a.length - b.length;
        });

        //remove duplicate start with same character
        var result = [];
        var length = query.length;
        for (var i = 0; i < length; i++) {
            var word = query[i];
            var ok = true;
            for (var j = i + 1; j < length; j++) {
                if (query[j].indexOf(word) === 0) {
                    ok = false;
                    break;
                }
            }
            if (ok) {
                result.push(word);
            }
        }

        return result;
    };

    var highlights = function (query, fields, result) {
        var coords = result.highlights.split(/ /);
        var length = coords.length;

        var i = 0;

        var colnumInc = Array.apply(null, Array(fields.length)).map(function () {
            return 0
        });
        while (i < length) {
            var colnum = coords[i++];
            var itemnum = coords[i++];
            var offset = parseInt(coords[i++]) + colnumInc[colnum];
            var size = coords[i++];

            var value = result.value[fields[colnum]];
            var queryLength = query[itemnum].length;

            result.value[fields[colnum]] = value.substr(0, offset) + "<b>" + value.substr(offset, queryLength) + "</b>" + value.substr(offset + queryLength);
            colnumInc[colnum] += 7;
        }
    };

    var view = function (fields) {
        var html = "";
        for (var field in fields) {
            html += fields[field] + "<br>";
        }
        return html;
    };

    console.log('start');
    $("#target").keyup(function (event) {
        var val = $(this).val();
        var result = $('#result');
        if (val.length >= minQueryLength) {
            var query = normalize(val);
            $.get("http://lyon.glicer.com/search/search.php?q=" + toQuery(query), function (data) {
                var html = "<div>";
                var fields = data.fields;
                var results = data.results;
                results.forEach(function (result) {
                    highlights(query, fields, result);
                    html += "<div>";
                    html += view(result.value);
                    html += "</div>";
                    html += "<br>";
                });
                html += "</div>";
                result.empty();
                result.append(html);
            });
        } else {
            result.empty();
        }
    });
</script>
</body>
</html>